# Karonte 快速参考卡

## 🚀 30秒快速开始

### 方法1: 使用自动化脚本（推荐）
```bash
./setup_new_firmware.sh 厂商名 设备名 /path/to/firmware.bin
# 例如: ./setup_new_firmware.sh TP_Link Archer_C7 ~/downloads/firmware.bin

# 然后运行生成的脚本
./run_analysis_厂商名_设备名.sh
```

### 方法2: 手动操作
```bash
# 1. 创建配置文件
cp config/config_example.json config/my_device.json

# 2. 编辑配置
nano config/my_device.json
# 必须修改: "fw_path": "你的固件路径"

# 3. 运行分析
python tool/karonte.py config/my_device.json

# 4. 查看结果
cat /tmp/Karonte.txt_*
```

---

## 📋 最小配置模板

### Linux 固件（路由器、IoT设备）
```json
{
    "fw_path": "./firmware/VENDOR/DEVICE/squashfs-root",
    "bin": [],
    "stats": "True",
    "pickle_parsers": "",
    "angr_explode_bins": ["openvpn", "vpn", "qemu-arm-static"],
    "data_keys": [],
    "glob_var": [],
    "arch": "",
    "only_string": "False"
}
```

### Blob 固件（bootloader）
```json
{
    "bin": ["./firmware/bootloader.bin"],
    "base_addr": "0x80000000",
    "eg_source_addr": "0x80001234",
    "arch": "ARM",
    "fw_path": "",
    "stats": "True",
    "pickle_parsers": "",
    "data_keys": [],
    "angr_explode_bins": [],
    "glob_var": [],
    "only_string": "False"
}
```

---

## 🔧 常用命令

### 固件提取
```bash
# 使用 binwalk
binwalk -e firmware.bin

# 查找文件系统根目录
find . -name "squashfs-root" -type d

# 检查二进制文件
file squashfs-root/usr/bin/httpd
```

### 运行分析
```bash
# 基本运行
python tool/karonte.py config/my_config.json

# 指定输出路径
python tool/karonte.py config/my_config.json results/my_results.txt

# 后台运行
nohup python tool/karonte.py config/my_config.json > analysis.log 2>&1 &

# 监控进度
tail -f analysis.log
```

### 查看结果
```bash
# 查看日志
cat /tmp/Karonte.txt_*

# 搜索告警
grep -i "alert\|warning\|vulnerability" /tmp/Karonte.txt_*

# 搜索发现的漏洞
grep -i "buffer overflow\|command injection" /tmp/Karonte.txt_*
```

---

## 🐛 快速故障排查

| 问题 | 解决方案 |
|------|---------|
| **分析卡住** | 在 `angr_explode_bins` 中添加问题二进制文件 |
| **没有发现边界二进制** | 在 `bin` 中手动指定二进制文件路径 |
| **内存不足** | 减少 `tool/utils.py` 中的 `MAX_THREADS` |
| **固件提取失败** | 使用 `binwalk -e` 手动提取 |
| **架构不支持** | 检查 `file` 命令输出，确认是 ARM/MIPS/x86 |

---

## 📊 配置参数速查

| 参数 | 必填 | 用途 |
|------|------|------|
| `fw_path` | Linux固件 | 文件系统根目录 |
| `bin` | Blob固件 | 二进制文件列表 |
| `base_addr` | Blob固件 | 加载基址 |
| `eg_source_addr` | Blob固件 | 输入函数地址 |
| `arch` | Blob固件 | 处理器架构 |
| `stats` | 是 | 统计信息开关 |
| `angr_explode_bins` | 否 | angr黑名单 |
| `pickle_parsers` | 否 | 缓存文件路径 |

---

## 💡 最佳实践

### ✅ 应该做
- 从简单固件开始测试
- 使用 `stats: "True"` 获取详细信息
- 保存配置文件以便复用
- 使用有意义的文件名和目录结构
- 在 `angr_explode_bins` 中排除无关二进制

### ❌ 不应该做
- 不要在生产服务器上运行（资源消耗大）
- 不要同时分析多个大型固件
- 不要忽略固件提取失败的警告
- 不要在 Docker 容器中运行（除非有足够资源）

---

## 📈 预期时间

| 固件类型 | 复杂度 | 预计时间 |
|---------|--------|---------|
| 小型 IoT | 简单 | 5-30 分钟 |
| 路由器 | 中等 | 1-3 小时 |
| 企业设备 | 复杂 | 3-12 小时 |
| Bootloader | 简单 | 10-60 分钟 |

---

## 🔍 结果解读

### 关键输出
1. **Border Binaries**: 网络暴露的二进制文件
2. **Binary Dependency Graph**: 进程间通信关系
3. **Alerts**: 发现的潜在漏洞
4. **Stats**: 分析统计（路径数、时间等）

### 漏洞类型
- **Buffer Overflow**: 缓冲区溢出
- **Command Injection**: 命令注入
- **Path Traversal**: 路径遍历
- **Format String**: 格式化字符串漏洞

---

## 📞 获取帮助

- 详细文档: `cat 新固件分析流程.md`
- 论文: [IEEE S&P 2020](https://www.badnack.it/static/papers/University/karonte.pdf)
- GitHub: https://github.com/angr/karonte
- angr 文档: https://docs.angr.io/

---

## 🎯 测试清单

分析前检查：
- [ ] 固件文件存在且完整
- [ ] 已安装 Python 依赖 (`pip install -r tool/requirements.txt`)
- [ ] 配置文件路径正确
- [ ] 磁盘空间充足（>10GB）
- [ ] 内存充足（推荐16GB+）
- [ ] 已设置合理的超时（如果需要）

---

**快速记忆口诀：**
1. 准备固件 📦
2. 提取文件 🔓
3. 创建配置 ⚙️
4. 运行分析 🚀
5. 查看结果 📊
